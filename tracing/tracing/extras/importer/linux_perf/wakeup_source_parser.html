<!DOCTYPE html>
<!--
Copyright (c) 2012 The Chromium Authors. All rights reserved.
Use of this source code is governed by a BSD-style license that can be
found in the LICENSE file.
-->

<link rel="import" href="/tracing/extras/importer/linux_perf/parser.html">

<script>
'use strict';

/**
 * @fileoverview Parses wakeup source events in the Linux event trace format.
 */
tr.exportTo('tr.e.importer.linux_perf', function() {

  const ColorScheme = tr.b.ColorScheme;
  const Parser = tr.e.importer.linux_perf.Parser;

  /**
   * Parses linux cpufreq trace events.
   * @constructor
   */
  function WakeupSourceParser(importer) {
    Parser.call(this, importer);

    importer.registerEventHandler('wakeup_source_activate',
        WakeupSourceParser.prototype.WSActivateEvent.bind(this));
    importer.registerEventHandler('wakeup_source_deactivate',
        WakeupSourceParser.prototype.WSDeactivateEvent.bind(this));

  }

  // Matches the workqueue_execute_start record
  //  wakeup_source_activate: event3 state=0x10a60006
  const WSActivateEventRE = /(.+) state=(\S+)/;
  // Matches the workqueue_execute_start record
  //  wakeup_source_activate: PowerManagerService.WakeLocks state=0x10ab0005
  const WSDeactivateEvenRE = /(.+) state=(\S+)/;

  WakeupSourceParser.prototype = {
    __proto__: Parser.prototype,

    /**
     * Parses wakeup_source_activate events and sets up state in the importer.
     */
    WSActivateEvent: function(eventName, cpuNumber, pid, ts, eventBase) {
      const event = WSActivateEventRE.exec(eventBase.details);
      if (!event) return false;
      const kthread = this.importer.getOrCreateKernelThread(
          eventBase.threadName, pid, pid);
      kthread.openSliceTS = ts;
      kthread.openSlice = event[1];
      return true;
    },

    /**
     * Parses wakeup_source_deactivate events and sets up state in the importer.
     */
    WSDeactivateEvent: function(eventName, cpuNumber, pid, ts, eventBase) {
      const event = WSDeactivateEvenRE.exec(eventBase.details);
      if (!event) return false;
      const kthread = this.importer.getOrCreateKernelThread(
          eventBase.threadName, pid, pid);
      if (kthread.openSlice) {
        const slice = new tr.model.ThreadSlice('', kthread.openSlice,
            ColorScheme.getColorIdForGeneralPurposeString(kthread.openSlice),
            kthread.openSliceTS,
            { state },
            ts - kthread.openSliceTS);
        kthread.thread.sliceGroup.pushSlice(slice);
      }
      kthread.openSlice = undefined;
      return true;
    },
  };

  Parser.register(WakeupSourceParser);

  return {
    WakeupSourceParser: WakeupSourceParser
  };
});
</script>
